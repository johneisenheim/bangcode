function Slave(){function e(){0==r?(Ti.API.info("countdown BANG!"),h.stop(),clearInterval(l),setTimeout(function(){startTime=new Date,f.play(),Ti.App.fireEvent("user_can_fire",{})},300)):(Ti.API.info(r),r-=1)}function t(){l=setInterval(e,1e3)}var i=null,n=null,a="notready",o=0,r=0,l=null;amITheMaster=0;var s=-1,d=!1,u=require("ui/quickGame/QuickGameFinderView"),c=new u,m=null,T=null,p=!0,f=ZLSound.createSample({media:"music/bell.mp3",volume:1}),h=ZLSound.createSample({media:"music/tic.mp3",volume:1}),g=Titanium.UI.createWindow({navTintColor:"white",tintColor:"#E2BB5A",barColor:"#E2BB5A",extendEdges:[Ti.UI.EXTEND_EDGE_TOP],backgroundColor:"#F5F4F2",translucent:!0,statusBarStyle:Titanium.UI.iPhone.StatusBar.GRAY,layout:"composite",tabBarHidden:!0,modal:!0,orientationModes:[1]}),v=Titanium.UI.createLabel({top:"55%",font:{fontSize:18,fontFamily:"Roboto-LightItalic"},text:"Controllo Bluetooth...",textAlign:"center",color:"#aa938b",width:"95%"}),I=Titanium.UI.createButton({title:"Chiudi",font:{fontSize:19},color:"#856C64",top:20,right:15}),w=Ti.UI.createAlertDialog({ok:"Okay",title:"Bang!"});loader.showLoader(g);var y=function(){i=require("com.pj"),n=i.createSession();n.checkBluetoothAccess();n.addEventListener("bluetoothState",function(e){switch(e.state){case"The connection with the system service was momentarily lost, update imminent.":break;case"The platform doesn't support Bluetooth Low Energy.":w.message="Il tuo dispositivo non supporta il bluetooth 4.0. Bang! non può funzionare su questi dispositivi.",w.show(),v.text="Bluetooth non supportato.",i=null,n=null;break;case"The app is not authorized to use Bluetooth Low Energy.":w.message="Non hai autorizzato Bang! a poter utilizzare il bluetooth.",w.show(),v.text="Bluetooth non autorizzato.",i=null,n=null;break;case"Bluetooth is currently powered off.":w.message="Il Bluetooth è spento! Per favore, accedi alle impostazioni e attivalo.",w.show(),v.text="Il Bluetooth è spento.";break;case"Bluetooth is currently powered on and available to use.":v.text="Ricerco la partita...",n.setupSessionAndStartServices(mID,Ti.App.Properties.getString("fb_id"),0),d=!0}}),n.addEventListener("didReceiveInvitationFromPeer",function(){v.text="Ho trovato la partita!Preparo il gioco..."}),n.addEventListener("connecting",function(){v.text="Connetto allo sfidante..."}),n.addEventListener("connected",function(){v.text="Connesso! Iniziamo...",setTimeout(function(){loader.hideLoader(g),g.remove(v),c.initialize(),g.add(c)},2e3)}),n.addEventListener("notConnected",function(){Ti.API.info("Ho lanciato il notConnected")}),n.addEventListener("didReceiveData",function(e){var i=e.message.split(":");switch(i[0]){case"tellme":a=c.getMyOwnStatus()?"ready":"notready",Ti.API.info("[INFO] Sending "+a);try{n.sendData(a+":")}catch(s){Ti.API.info("Telepathy status in tellme case in didreceivedata")}break;case"start":r=3+parseInt(o),Ti.API.info("[INFO] Counter is "+r),t(),h.play();break;case"random":o=i[1];break;case"youWin":n.stopServices(),setTimeout(function(){var e=require("ui/winlose/Win"),t=new e(g);t.setLabelText("Hai vinto. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),g.remove(T),g.add(t),t.playSound()},2500);break;case"youLoose":n.stopServices(),setTimeout(function(){var e=require("ui/winlose/Lose"),t=new e(g);t.setLabelText(999999999==myTime?"Hai mancato il tuo avversario! Aggiusta la mira, gringo!":"Hai perso. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),g.remove(T),g.add(t),t.playSound()},2500);break;case"draw":n.stopServices();var d=require("ui/winlose/Lose"),u=new d(g);u.setLabelText("Avete perso entrambi...Impara bene gringo, rischi la pelle nel vecchio west!"),setTimeout(function(){g.remove(T),g.add(u),u.playSound()},2500);break;case"times":if(vsTime=i[1],888888888==vsTime){clearInterval(l),h.stop(),m=require("ui/winlose/Calculating"),T=new m;var p=null;null!=c&&(p=c.getMotionObject(),c.removeEventOnOrientation(),p.stopMotionRecognizer(),g.remove(c)),g.add(T);var f=require("ui/winlose/Win"),v=new f(g);v.setLabelText("Hai vinto! Il tuo avversario ha sparato per primo. Avrà mica voluto barare?"),setTimeout(function(){g.remove(T),g.add(v),v.playSound()},2500)}else if(0!=myTime)try{n.sendData("calculate:"+myTime)}catch(s){Ti.API.info("calculate in times case in didreceivedata")}}})};g.setMasterID=function(e){s=e},g.addEventListener("open",y),I.addEventListener("click",function(){g.close()}),Ti.App.addEventListener("timeExchange",function(e){if(p){p=!1,Ti.API.info("timeExchange");try{n.sendData("acceleration:"+e.acceleration)}catch(t){Ti.API.info("Telepathy acceleration timeExchange")}m=require("ui/winlose/Calculating"),T=new m;var i=null;if(null!=c&&(i=c.getMotionObject(),c.removeEventOnOrientation(),i.stopMotionRecognizer(),g.remove(c)),g.add(T),999999999==e.flag){myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(t){Ti.API.info("Telepathy times timeExchange")}}else if(888888888==e.flag){Ti.API.info("flag is 888888888"),clearInterval(l),h.stop(),myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(t){Ti.API.info("Telepathy times timeExchange")}var a=require("ui/winlose/Lose"),o=new a(g);o.setLabelText("Ehi gringo, attento! Hai sparato troppo presto!"),setTimeout(function(){g.remove(T),g.add(o),o.playSound()},2500)}else{myTime=diffTime;try{n.sendData("times:"+diffTime)}catch(t){Ti.API.info("Telepathy times timeExchange else")}}}}),g.add(v),g.add(I);var A=function(){Ti.API.info("closing window..."),n.stopServices(),i=null,n=null,myTime=0,vsTime=0,startTime=0,endTime=0,diffTime=0,c.deallocModule(),c=null,u=null};return g.addEventListener("close",A),g}module.exports=Slave;