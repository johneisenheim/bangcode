function Master(){function e(){0==l?(Ti.API.info("countdown BANG!"),g.stop(),clearInterval(s),setTimeout(function(){startTime=new Date,h.play(),Ti.App.fireEvent("user_can_fire",{})},300)):(Ti.API.info(l),l-=1)}function t(){s=setInterval(e,1e3)}var i=null,n=null,a=!1,o=require("ui/quickGame/QuickGameView"),r=new o,l=0,s=null,d=null,u=null;amITheMaster=1;var c=!0,m=0,T=0,p=0,f=Math.floor(4*Math.random()+1),h=ZLSound.createSample({media:"music/bell.mp3",volume:1}),g=ZLSound.createSample({media:"music/tic.mp3",volume:1}),v=0,I=Titanium.UI.createWindow({navTintColor:"white",tintColor:"#E2BB5A",barColor:"#E2BB5A",extendEdges:[Ti.UI.EXTEND_EDGE_TOP],backgroundColor:"#F5F4F2",translucent:!0,statusBarStyle:Titanium.UI.iPhone.StatusBar.GRAY,layout:"composite",tabBarHidden:!0,modal:!0,orientationModes:[1]}),A=Titanium.UI.createLabel({top:"55%",font:{fontSize:17,fontFamily:"Roboto-LightItalic"},text:"Cerco l'avversario...",textAlign:"center",color:"#aa938b",width:"95%"});loader.showLoader(I);var y=Titanium.UI.createButton({title:"Chiudi",font:{fontSize:19},color:"#856C64",top:20,right:15}),w=Ti.UI.createAlertDialog({ok:"Okay",title:"Bang!"}),S=function(){Ti.API.info("initQuickGameCallback"),Ti.API.info("Telepathy is null"),i=require("com.pj"),n=i.createSession();n.checkBluetoothAccess();n.addEventListener("bluetoothState",function(e){switch(e.state){case"The connection with the system service was momentarily lost, update imminent.":break;case"The platform doesn't support Bluetooth Low Energy.":w.message="Il tuo dispositivo non supporta il bluetooth 4.0. Bang! non può funzionare su questi dispositivi.",w.show(),A.text="Bluetooth non supportato.",i=null,n=null;break;case"The app is not authorized to use Bluetooth Low Energy.":w.message="Non hai autorizzato Bang! a poter utilizzare il bluetooth.",w.show(),A.text="Bluetooth non autorizzato.",i=null,n=null;break;case"Bluetooth is currently powered off.":w.message="Il Bluetooth è spento! Per favore, accedi alle impostazioni e attivalo.",w.show(),A.text="Il Bluetooth è spento.";break;case"Bluetooth is currently powered on and available to use.":A.text="Ricerco l'avversario...",Ti.API.info(v),n.setupSessionAndStartServices(Ti.App.Properties.getString("fb_id"),v,1),a=!0}}),n.addEventListener("connecting",function(){A.text="Connetto allo sfidante..."}),n.addEventListener("connected",function(){A.text="Connesso! Iniziamo...",setTimeout(function(){loader.hideLoader(I),I.remove(A),Ti.API.info("calling initialize from setTimeout"),r.initialize(),I.add(r);try{n.sendData("tellme:")}catch(e){Ti.API.info("Telepathy tell me in connected event listener")}try{n.sendData("random:"+f)}catch(e){Ti.API.info("Telepathy random in connected event listener")}},2e3)}),n.addEventListener("notConnected",function(){n.tryToReconnect(Ti.App.Properties.getString("fb_id"),v,1)}),n.addEventListener("didReceiveData",function(e){var i=e.message.split(":");switch(Ti.API.info("[INFO] RECEIVED MESSAGE : "+i[0]),i[0]){case"notready":try{n.sendData("tellme:")}catch(a){Ti.API.info("Telepathy tell me in didreceivedata")}break;case"ready":if(Ti.API.info("Can I send Start packet? "+r.canISendStartPacket()),r.canISendStartPacket()){try{n.sendData("start:")}catch(a){Ti.API.info("Telepathy start in case ready in didreceivedata")}l=3+f,g.play(),t()}else try{n.sendData("tellme:")}catch(a){Ti.API.info("Telepathy tellme in case ready in didreceivedata")}break;case"calculate":if(vsTime=i[1],Ti.API.info("vs time is "+vsTime),vsTime>myTime){try{n.sendData("youLoose:")}catch(a){Ti.API.info("Telepathy youloose in calculate in didreceivedata")}var o=require("ui/winlose/Win"),c=new o(I);p=Ti.App.Properties.getString("fb_id"),sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(c),c.playSound()},2500)}else if(myTime>vsTime){try{n.sendData("youWin:")}catch(a){Ti.API.info("Telepathy youwin in calculate in didreceivedata")}var h=require("ui/winlose/Lose"),A=new h(I);p=v,sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(A),A.playSound()},2500)}else{try{n.sendData("youLoose:")}catch(a){Ti.API.info("Telepathy youloose in calculate in didreceivedata 2")}var h=require("ui/winlose/Lose"),A=new h(I);p=v,sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(A),A.playSound()},2500)}break;case"times":if(vsTime=i[1],888888888==vsTime){clearInterval(s),g.stop(),d=require("ui/winlose/Calculating"),u=new d;var y=null;null!=r&&(y=r.getMotionObject(),r.removeEventOnOrientation(),y.stopMotionRecognizer(),I.remove(r)),I.add(u);var o=require("ui/winlose/Win"),c=new o(I);c.setLabelText("Hai vinto! Il tuo avversario ha sparato per primo. Avrà mica voluto barare?"),p=Ti.App.Properties.getString("fb_id"),sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){I.remove(u),I.add(c),c.playSound()},2500)}else if(0!=myTime)if(myTime==vsTime){try{n.sendData("draw:")}catch(a){Ti.API.info("Telepathy youloose in calculate in didreceivedata 3")}var h=require("ui/winlose/Lose"),A=new h(I);A.setLabelText("Avete perso entrambi...Impara bene gringo, rischi la pelle nel vecchio west!"),p=v,sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(A),A.playSound()},2500)}else if(vsTime>myTime){try{n.sendData("youLoose:")}catch(a){Ti.API.info("Telepathy youloose in calculate in didreceivedata 3")}var o=require("ui/winlose/Win"),c=new o(I);c.setLabelText("Hai vinto. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),p=Ti.App.Properties.getString("fb_id"),sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(c),c.playSound()},2500)}else{try{n.sendData("youWin:")}catch(a){Ti.API.info("Telepathy youwin in calculate in didreceivedata 2")}var h=require("ui/winlose/Lose"),A=new h(I);A.setLabelText("Hai perso. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),p=v,sendDataToServer(v,p,f,myTime,vsTime,m,T),setTimeout(function(){n.stopServices(),I.remove(u),I.add(A),A.playSound()},2500)}break;case"acceleration":T=i[1]}})};I.setIDOpponent=function(e){Ti.API.info("Opponent ID is "+e),v=e},I.addEventListener("open",S),y.addEventListener("click",function(){I.close()}),Ti.App.addEventListener("timeExchange",function(e){if(c){c=!1,d=require("ui/winlose/Calculating"),u=new d;var t=null;if(null!=r&&(t=r.getMotionObject(),r.removeEventOnOrientation(),t.stopMotionRecognizer(),I.remove(r)),I.add(u),999999999==e.flag){Ti.API.info("e.flag: "+e.flag),myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(i){Ti.API.info("Telepathy times in timeExchange")}}else if(888888888==e.flag){clearInterval(s),g.stop(),myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(i){Ti.API.info("Telepathy times timeExchange")}var a=require("ui/winlose/Lose"),o=new a(I);o.setLabelText("Ehi gringo, attento! Hai sparato troppo presto!"),setTimeout(function(){I.remove(u),I.add(o),o.playSound()},2500)}else{myTime=diffTime,Ti.API.info("myTime not parsed "+myTime),Ti.API.info("myTime parsed "+parseFloat(myTime));try{n.sendData("times:"+diffTime)}catch(i){Ti.API.info("Telepathy times in timeExchange else")}}}}),I.add(A),I.add(y);var b=function(){Ti.API.info("closing window..."),n.stopServices(),i=null,n=null,myTime=0,vsTime=0,startTime=0,endTime=0,diffTime=0,r.deallocModule(),r=null,o=null};return I.addEventListener("close",b),I}function sendDataToServer(e,t,i,n,a,o,r){var l=Ti.Network.createHTTPClient({onload:function(){Ti.API.info("Received text: "+this.responseText);var e=JSON.parse(this.responseText);0==e.return?Ti.API.info("duello registrato"):-1==e.return&&Ti.API.info("duello NON registrato")},onerror:function(e){Ti.API.debug(e.error)},timeout:5e3}),s={player_one:Ti.App.Properties.getString("fb_id"),player_two:e,id_winner:t,status:0,round_time:i,acceleration1:o,acceleration2:r,diff_timestamp1:n,diff_timestamp2:a};s.num_faults1=999999999==n?1:0,s.num_faults2=999999999==a?1:0,Ti.API.info(JSON.stringify(s)),l.open("GET",global.bangServerUrl+"/challenge-quickgameChallenge.php?challenge="+JSON.stringify(s)),l.send()}module.exports=Master;