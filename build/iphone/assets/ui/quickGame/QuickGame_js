function QuickGame(){function e(){0==r?(Ti.API.info("countdown BANG!"),f.stop(),clearInterval(l),setTimeout(function(){startTime=new Date,g.play(),Ti.App.fireEvent("user_can_fire",{})},300)):(Ti.API.info(r),r-=1)}function t(){l=setInterval(e,1e3)}var i=null,o=null,n=require("ui/quickGame/QuickGameView"),a=new n,r=0,l=null,s=null,d=null,u=!0,c=0,T=0,h=0,m=Math.floor(4*Math.random()+1),g=ZLSound.createSample({media:"music/bell.mp3",volume:1}),f=ZLSound.createSample({media:"music/tic.mp3",volume:1}),p=0,I=Titanium.UI.createWindow({navTintColor:"white",tintColor:"#E2BB5A",barColor:"#E2BB5A",extendEdges:[Ti.UI.EXTEND_EDGE_TOP],backgroundColor:"#F5F4F2",translucent:!0,statusBarStyle:Titanium.UI.iPhone.StatusBar.GRAY,layout:"composite",tabBarHidden:!0,modal:!0,orientationModes:[1]}),w=Titanium.UI.createLabel({top:"55%",font:{fontSize:17,fontFamily:"Roboto-LightItalic"},text:"Cerco l'avversario...",textAlign:"center",color:"#aa938b",width:"95%"});loader.showLoader(I);var b=Titanium.UI.createButton({title:"Chiudi",font:{fontSize:19},color:"#856C64",top:20,right:15}),v=Ti.UI.createAlertDialog({ok:"Okay",title:"Bang!"}),S=function(){Ti.API.info("initQuickGameCallback"),Ti.API.info("Telepathy is null"),i=require("com.pj"),o=i.createSession();o.checkBluetoothAccess();o.addEventListener("bluetoothState",function(e){switch(e.state){case"The connection with the system service was momentarily lost, update imminent.":break;case"The platform doesn't support Bluetooth Low Energy.":v.message="Il tuo dispositivo non supporta il bluetooth 4.0. Bang! non può funzionare su questi dispositivi.",v.show(),w.text="Bluetooth non supportato.",i=null,o=null;break;case"The app is not authorized to use Bluetooth Low Energy.":v.message="Non hai autorizzato Bang! a poter utilizzare il bluetooth.",v.show(),w.text="Bluetooth non autorizzato.",i=null,o=null;break;case"Bluetooth is currently powered off.":v.message="Il Bluetooth è spento! Per favore, accedi alle impostazioni e attivalo.",v.show(),w.text="Il Bluetooth è spento.";break;case"Bluetooth is currently powered on and available to use.":w.text="Ricerco l'avversario...",Ti.API.info(p),o.setupSessionAndStartServices(Ti.App.Properties.getString("fb_id"),p,1)}}),o.addEventListener("connecting",function(){w.text="Connetto allo sfidante..."}),o.addEventListener("connected",function(){w.text="Connesso! Iniziamo...",setTimeout(function(){loader.hideLoader(I),I.remove(w),a.initialize(),I.add(a),o.sendData("tellme:"),o.sendData("random:"+m)},2e3)}),o.addEventListener("notConnected",function(){o.tryToReconnect(Ti.App.Properties.getString("fb_id"),p,1)}),o.addEventListener("didReceiveData",function(e){var i=e.message.split(":");switch(Ti.API.info("[INFO] RECEIVED MESSAGE : "+i[0]),i[0]){case"notready":o.sendData("tellme:");break;case"ready":Ti.API.info("Can I send Start packet? "+a.canISendStartPacket()),a.canISendStartPacket()?(o.sendData("start:"),r=3+m,f.play(),t()):o.sendData("tellme:");break;case"fault":f.stop(),clearInterval(l),myTime=0,vsTime=888888888;var n=a.getMotionObject();n.stopMotionRecognizer();var s=require("ui/winlose/Win"),u=new s(I);h=Ti.App.Properties.getString("fb_id"),sendDataToServer(p,h,m,myTime,vsTime,c,T),I.add(u),u.playSound();break;case"calculate":if(vsTime=i[1],Ti.API.info("vs time is "+vsTime),vsTime>myTime){o.sendData("youLoose:");var s=require("ui/winlose/Win"),u=new s(I);h=Ti.App.Properties.getString("fb_id"),sendDataToServer(p,h,m,myTime,vsTime,c,T),setTimeout(function(){I.remove(d),I.add(u),u.playSound()},2500)}else if(myTime>vsTime){o.sendData("youWin:");var g=require("ui/winlose/Lose"),w=new g(I);h=p,sendDataToServer(p,h,m,myTime,vsTime,c,T),setTimeout(function(){I.remove(d),I.add(w),w.playSound()},2500)}else{o.sendData("youLoose:");var g=require("ui/winlose/Lose"),w=new g(I);h=p,sendDataToServer(p,h,m,myTime,vsTime,c,T),setTimeout(function(){I.remove(d),I.add(w),w.playSound()},2500)}break;case"times":if(vsTime=i[1],Ti.API.info("vs time is "+vsTime),0!=myTime)if(vsTime>myTime){o.sendData("youLoose:");var s=require("ui/winlose/Win"),u=new s(I);u.setLabelText("Hai vinto. Il tuo tempo è "+myTime+" e il tempo dell'avversario è "+vsTime),h=Ti.App.Properties.getString("fb_id"),sendDataToServer(p,h,m,myTime,vsTime,c,T),setTimeout(function(){I.remove(d),I.add(u),u.playSound()},2500)}else{o.sendData("youWin:");var g=require("ui/winlose/Lose"),w=new g(I);w.setLabelText("Hai perso. Il tuo tempo è "+myTime+" e il tempo dell'avversario è "+vsTime),sendDataToServer(p,h,m,myTime,vsTime,c,T),h=p,setTimeout(function(){I.remove(d),I.add(w),w.playSound()},2500)}break;case"acceleration":T=i[1]}})};return Ti.App.addEventListener("fault",function(){clearInterval(l),f.stop(),o.sendData("fault:")}),I.setIDOpponent=function(e){Ti.API.info("Opponent ID is "+e),p=e},I.addEventListener("open",S),b.addEventListener("click",function(){o.stopServices(),i=null,o=null,I.close()}),Ti.App.addEventListener("timeExchange",function(e){if(u){if(999999999==e.flag||88888888==e.flag){Ti.API.info("e.flag: "+e.flag),myTime=e.flag;try{o.sendData("times:"+e.flag)}catch(t){}}else{myTime=diffTime,Ti.API.info("myTime not parsed "+myTime),Ti.API.info("myTime parsed "+parseFloat(myTime));try{o.sendData("times:"+diffTime)}catch(t){}}c=e.acceleration,s=require("ui/winlose/Calculating"),d=new s,a.removeEventOnOrientation(),I.remove(a),I.add(d),u=!1}}),I.add(w),I.add(b),I.addEventListener("close",function(){Ti.API.info("closing window..."),o.stopServices(),i=null,o=null,myTime=0,vsTime=0,startTime=0,endTime=0,diffTime=0,a.deallocModule(),a=null,n=null}),I}function sendDataToServer(e,t,i,o,n,a,r){var l=Ti.Network.createHTTPClient({onload:function(){Ti.API.info("Received text: "+this.responseText);var e=JSON.parse(this.responseText);0==e.return?Ti.API.info("duello registrato"):-1==e.return&&Ti.API.info("duello NON registrato")},onerror:function(e){Ti.API.debug(e.error)},timeout:5e3}),s={player_one:Ti.App.Properties.getString("fb_id"),player_two:e,id_winner:t,status:0,round_time:i,acceleration1:a,acceleration2:r,diff_timestamp1:o,diff_timestamp2:n};s.num_faults1=999999999==o?1:0,s.num_faults2=999999999==n?1:0,Ti.API.info(JSON.stringify(s)),l.open("GET",global.bangServerUrl+"/challenge-quickgameChallenge.php?challenge="+JSON.stringify(s)),l.send()}module.exports=QuickGame;