function QuickGame(e){function t(){0==s?(Ti.API.info("countdown BANG!"),b.stop(),clearInterval(d),setTimeout(function(){startTime=new Date,S.play(),Ti.App.fireEvent("user_can_fire",{})},300)):(Ti.API.info(s),s-=1)}function i(){d=setInterval(t,1e3)}var o=null,n=null,a=!1,r=require("ui/quickGame/QuickGameView"),l=new r,s=0,d=null,c=null,u=null;amITheMaster=1;var m=require("ui/customUI/Loader"),T=new m,p=require("ui/customUI/Loader2"),h=new p,f=!0,g=0,I=0,v=0,w=Math.floor(4*Math.random()+1),S=ZLSound.createSample({media:"music/bell.mp3",volume:1}),b=ZLSound.createSample({media:"music/tic.mp3",volume:1}),y=0,A=Titanium.UI.createWindow({navTintColor:"white",tintColor:"#E2BB5A",barColor:"#E2BB5A",extendEdges:[Ti.UI.EXTEND_EDGE_TOP],backgroundColor:"#F5F4F2",translucent:!0,statusBarStyle:Titanium.UI.iPhone.StatusBar.GRAY,layout:"composite",tabBarHidden:!0,modal:!0,orientationModes:[1]}),E=Titanium.UI.createLabel({top:"55%",font:{fontSize:17,fontFamily:"Roboto-LightItalic"},text:"Cerco l'avversario...",textAlign:"center",color:"#aa938b",width:"95%"}),L=Titanium.UI.createButton({title:"Chiudi",font:{fontSize:19},color:"#856C64",top:20,right:15}),P=Ti.UI.createAlertDialog({ok:"Okay",title:"Bang!"}),C=function(){Ti.API.info("initQuickGameCallback"),Ti.API.info("Telepathy is null"),o=require("com.pj"),n=o.createSession();n.checkBluetoothAccess();n.addEventListener("bluetoothState",function(e){switch(e.state){case"The connection with the system service was momentarily lost, update imminent.":break;case"The platform doesn't support Bluetooth Low Energy.":P.message="Il tuo dispositivo non supporta il bluetooth 4.0. Bang! non può funzionare su questi dispositivi.",P.show(),E.text="Bluetooth non supportato.",o=null,n=null;break;case"The app is not authorized to use Bluetooth Low Energy.":P.message="Non hai autorizzato Bang! a poter utilizzare il bluetooth.",P.show(),E.text="Bluetooth non autorizzato.",o=null,n=null;break;case"Bluetooth is currently powered off.":P.message="Il Bluetooth è spento! Per favore, accedi alle impostazioni e attivalo.",P.show(),E.text="Il Bluetooth è spento.";break;case"Bluetooth is currently powered on and available to use.":E.text="Ricerco l'avversario...",Ti.API.info(y),n.setupSessionAndStartServices(Ti.App.Properties.getString("fb_id"),y,1),a=!0}}),n.addEventListener("connecting",function(){E.text="Connetto allo sfidante..."}),n.addEventListener("connected",function(){E.text="Connesso! Iniziamo...",setTimeout(function(){e?h.hideLoader(A):T.hideLoader(A),A.remove(E),Ti.API.info("calling initialize from setTimeout"),l.initialize(),A.add(l);try{n.sendData("tellme:")}catch(t){Ti.API.info("Telepathy tell me in connected event listener")}try{n.sendData("random:"+w)}catch(t){Ti.API.info("Telepathy random in connected event listener")}},2e3)}),n.addEventListener("notConnected",function(){n.tryToReconnect(Ti.App.Properties.getString("fb_id"),y,1)}),n.addEventListener("didReceiveData",function(e){var t=e.message.split(":");switch(Ti.API.info("[INFO] RECEIVED MESSAGE : "+t[0]),t[0]){case"notready":try{n.sendData("tellme:")}catch(o){Ti.API.info("Telepathy tell me in didreceivedata")}break;case"ready":if(Ti.API.info("Can I send Start packet? "+l.canISendStartPacket()),l.canISendStartPacket()){try{n.sendData("start:")}catch(o){Ti.API.info("Telepathy start in case ready in didreceivedata")}s=3+w,b.play(),i()}else try{n.sendData("tellme:")}catch(o){Ti.API.info("Telepathy tellme in case ready in didreceivedata")}break;case"calculate":if(vsTime=t[1],Ti.API.info("vs time is "+vsTime),vsTime>myTime){try{n.sendData("youLoose:")}catch(o){Ti.API.info("Telepathy youloose in calculate in didreceivedata")}var a=require("ui/winlose/Win"),r=new a(A);v=Ti.App.Properties.getString("fb_id"),sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(r),r.playSound()},2500)}else if(myTime>vsTime){try{n.sendData("youWin:")}catch(o){Ti.API.info("Telepathy youwin in calculate in didreceivedata")}var m=require("ui/winlose/Lose"),T=new m(A);v=y,sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(T),T.playSound()},2500)}else{try{n.sendData("youLoose:")}catch(o){Ti.API.info("Telepathy youloose in calculate in didreceivedata 2")}var m=require("ui/winlose/Lose"),T=new m(A);v=y,sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(T),T.playSound()},2500)}break;case"times":if(vsTime=t[1],888888888==vsTime){clearInterval(d),b.stop(),c=require("ui/winlose/Calculating"),u=new c;var p=null;null!=l&&(p=l.getMotionObject(),l.removeEventOnOrientation(),p.stopMotionRecognizer(),A.remove(l)),A.add(u);var a=require("ui/winlose/Win"),r=new a(A);r.setLabelText("Hai vinto! Il tuo avversario ha sparato per primo. Avrà mica voluto barare?"),v=Ti.App.Properties.getString("fb_id"),sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){A.remove(u),A.add(r),r.playSound()},2500)}else if(0!=myTime)if(myTime==vsTime){try{n.sendData("draw:")}catch(o){Ti.API.info("Telepathy youloose in calculate in didreceivedata 3")}var m=require("ui/winlose/Lose"),T=new m(A);T.setLabelText("Avete perso entrambi...Impara bene gringo, rischi la pelle nel vecchio west!"),v=y,sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(T),T.playSound()},2500)}else if(vsTime>myTime){try{n.sendData("youLoose:")}catch(o){Ti.API.info("Telepathy youloose in calculate in didreceivedata 3")}var a=require("ui/winlose/Win"),r=new a(A);r.setLabelText("Hai vinto. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),v=Ti.App.Properties.getString("fb_id"),sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(r),r.playSound()},2500)}else{try{n.sendData("youWin:")}catch(o){Ti.API.info("Telepathy youwin in calculate in didreceivedata 2")}var m=require("ui/winlose/Lose"),T=new m(A);T.setLabelText("Hai perso. Il tuo tempo è "+myTime+"ms e il tempo dell'avversario è "+vsTime),v=y,sendDataToServer(y,v,w,myTime,vsTime,g,I),setTimeout(function(){n.stopServices(),A.remove(u),A.add(T),T.playSound()},2500)}break;case"acceleration":I=t[1]}})};A.setIDOpponent=function(e){Ti.API.info("Opponent ID is "+e),y=e},A.addEventListener("open",C),L.addEventListener("click",function(){A.close()}),Ti.App.addEventListener("timeExchange",function(e){if(f){f=!1,c=require("ui/winlose/Calculating"),u=new c;var t=null;if(null!=l&&(t=l.getMotionObject(),l.removeEventOnOrientation(),t.stopMotionRecognizer(),A.remove(l)),A.add(u),999999999==e.flag){Ti.API.info("e.flag: "+e.flag),myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(i){Ti.API.info("Telepathy times in timeExchange")}}else if(888888888==e.flag){clearInterval(d),b.stop(),myTime=e.flag;try{n.sendData("times:"+e.flag)}catch(i){Ti.API.info("Telepathy times timeExchange")}var o=require("ui/winlose/Lose"),a=new o(A);a.setLabelText("Ehi gringo, attento! Hai sparato troppo presto!"),setTimeout(function(){A.remove(u),A.add(a),a.playSound()},2500)}else{myTime=diffTime,Ti.API.info("myTime not parsed "+myTime),Ti.API.info("myTime parsed "+parseFloat(myTime));try{n.sendData("times:"+diffTime)}catch(i){Ti.API.info("Telepathy times in timeExchange else")}}}}),A.add(E),A.add(L),Ti.API.info("isReloading "+e),e||T.showLoader(A);var _=function(){Ti.API.info("closing window..."),n.stopServices(),o=null,n=null,m=null,T=null,myTime=0,vsTime=0,startTime=0,endTime=0,diffTime=0,l.deallocModule(),l=null,r=null};return A.addEventListener("close",_),A.addEventListener("focus",function(){Ti.API.info("FOCUS"),e&&h.showLoader(A)}),Ti.App.addEventListener("resume",function(){Ti.API.info("resumed"),T.hideLoader(A),T.showLoader(A)}),A}function sendDataToServer(e,t,i,o,n,a,r){var l=Ti.Network.createHTTPClient({onload:function(){Ti.API.info("Received text: "+this.responseText);var e=JSON.parse(this.responseText);0==e.return?Ti.API.info("duello registrato"):-1==e.return&&Ti.API.info("duello NON registrato")},onerror:function(e){Ti.API.debug(e.error)},timeout:5e3}),s={player_one:Ti.App.Properties.getString("fb_id"),player_two:e,id_winner:t,status:0,round_time:i,acceleration1:a,acceleration2:r,diff_timestamp1:o,diff_timestamp2:n};s.num_faults1=999999999==o?1:0,s.num_faults2=999999999==n?1:0,Ti.API.info(JSON.stringify(s)),l.open("GET",global.bangServerUrl+"/challenge-quickgameChallenge.php?challenge="+JSON.stringify(s)),l.send()}module.exports=QuickGame;