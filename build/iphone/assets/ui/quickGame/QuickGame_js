function QuickGame(){function e(){0==l?(Ti.API.info("countdown BANG!"),f.stop(),clearInterval(s),setTimeout(function(){startTime=new Date,p.play(),Ti.App.fireEvent("user_can_fire",{})},300)):(Ti.API.info(l),l-=1)}function t(){s=setInterval(e,1e3)}var i=null,o=null,n=!1,a=require("ui/quickGame/QuickGameView"),r=new a,l=0,s=null,d=null,c=null;amITheMaster=1;var u=!0,m=0,T=0,h=0,g=Math.floor(4*Math.random()+1),p=ZLSound.createSample({media:"music/bell.mp3",volume:1}),f=ZLSound.createSample({media:"music/tic.mp3",volume:1}),I=0,w=Titanium.UI.createWindow({navTintColor:"white",tintColor:"#E2BB5A",barColor:"#E2BB5A",extendEdges:[Ti.UI.EXTEND_EDGE_TOP],backgroundColor:"#F5F4F2",translucent:!0,statusBarStyle:Titanium.UI.iPhone.StatusBar.GRAY,layout:"composite",tabBarHidden:!0,modal:!0,orientationModes:[1]}),v=Titanium.UI.createLabel({top:"55%",font:{fontSize:17,fontFamily:"Roboto-LightItalic"},text:"Cerco l'avversario...",textAlign:"center",color:"#aa938b",width:"95%"});loader.showLoader(w);var b=Titanium.UI.createButton({title:"Chiudi",font:{fontSize:19},color:"#856C64",top:20,right:15}),S=Ti.UI.createAlertDialog({ok:"Okay",title:"Bang!"}),y=function(){Ti.API.info("initQuickGameCallback"),Ti.API.info("Telepathy is null"),i=require("com.pj"),o=i.createSession();o.checkBluetoothAccess();o.addEventListener("bluetoothState",function(e){switch(e.state){case"The connection with the system service was momentarily lost, update imminent.":break;case"The platform doesn't support Bluetooth Low Energy.":S.message="Il tuo dispositivo non supporta il bluetooth 4.0. Bang! non può funzionare su questi dispositivi.",S.show(),v.text="Bluetooth non supportato.",i=null,o=null;break;case"The app is not authorized to use Bluetooth Low Energy.":S.message="Non hai autorizzato Bang! a poter utilizzare il bluetooth.",S.show(),v.text="Bluetooth non autorizzato.",i=null,o=null;break;case"Bluetooth is currently powered off.":S.message="Il Bluetooth è spento! Per favore, accedi alle impostazioni e attivalo.",S.show(),v.text="Il Bluetooth è spento.";break;case"Bluetooth is currently powered on and available to use.":v.text="Ricerco l'avversario...",Ti.API.info(I),o.setupSessionAndStartServices(Ti.App.Properties.getString("fb_id"),I,1),n=!0}}),o.addEventListener("connecting",function(){v.text="Connetto allo sfidante..."}),o.addEventListener("connected",function(){v.text="Connesso! Iniziamo...",setTimeout(function(){loader.hideLoader(w),w.remove(v),Ti.API.info("calling initialize from setTimeout"),r.initialize(),w.add(r);try{o.sendData("tellme:")}catch(e){alert("Telepathy tell me in connected event listener")}try{o.sendData("random:"+g)}catch(e){alert("Telepathy random in connected event listener")}},2e3)}),o.addEventListener("notConnected",function(){o.tryToReconnect(Ti.App.Properties.getString("fb_id"),I,1)}),o.addEventListener("didReceiveData",function(e){var i=e.message.split(":");switch(Ti.API.info("[INFO] RECEIVED MESSAGE : "+i[0]),i[0]){case"notready":try{o.sendData("tellme:")}catch(n){alert("Telepathy tell me in didreceivedata")}break;case"ready":if(Ti.API.info("Can I send Start packet? "+r.canISendStartPacket()),r.canISendStartPacket()){try{o.sendData("start:")}catch(n){alert("Telepathy start in case ready in didreceivedata")}l=3+g,f.play(),t()}else try{o.sendData("tellme:")}catch(n){alert("Telepathy tellme in case ready in didreceivedata")}break;case"calculate":if(vsTime=i[1],Ti.API.info("vs time is "+vsTime),vsTime>myTime){try{o.sendData("youLoose:")}catch(n){alert("Telepathy youloose in calculate in didreceivedata")}var a=require("ui/winlose/Win"),u=new a(w);h=Ti.App.Properties.getString("fb_id"),sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(u),u.playSound()},2500)}else if(myTime>vsTime){try{o.sendData("youWin:")}catch(n){alert("Telepathy youwin in calculate in didreceivedata")}var p=require("ui/winlose/Lose"),v=new p(w);h=I,sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(v),v.playSound()},2500)}else{try{o.sendData("youLoose:")}catch(n){alert("Telepathy youloose in calculate in didreceivedata 2")}var p=require("ui/winlose/Lose"),v=new p(w);h=I,sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(v),v.playSound()},2500)}break;case"times":if(vsTime=i[1],888888888==vsTime){clearInterval(s),f.stop(),d=require("ui/winlose/Calculating"),c=new d;var b=r.getMotionObject();r.removeEventOnOrientation(),b.stopMotionRecognizer(),w.remove(r),w.add(c);var a=require("ui/winlose/Win"),u=new a(w);u.setLabelText("Hai vinto! Il tuo avversario ha sparato per primo. Avrà mica voluto barare?"),h=Ti.App.Properties.getString("fb_id"),sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){w.remove(c),w.add(u),u.playSound()},2500)}else if(0!=myTime)if(myTime==vsTime){try{o.sendData("youLoose:")}catch(n){alert("Telepathy youloose in calculate in didreceivedata 3")}var p=require("ui/winlose/Lose"),v=new p(w);v.setLabelText("Avete perso entrambi...Impara bene gringo, rischi la pelle nel vecchio west!"),h=I,sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(v),v.playSound()},2500)}else if(vsTime>myTime){try{o.sendData("youLoose:")}catch(n){alert("Telepathy youloose in calculate in didreceivedata 3")}var a=require("ui/winlose/Win"),u=new a(w);u.setLabelText("Hai vinto. Il tuo tempo è "+myTime+" e il tempo dell'avversario è "+vsTime),h=Ti.App.Properties.getString("fb_id"),sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(u),u.playSound()},2500)}else{try{o.sendData("youWin:")}catch(n){alert("Telepathy youwin in calculate in didreceivedata 2")}var p=require("ui/winlose/Lose"),v=new p(w);v.setLabelText("Hai perso. Il tuo tempo è "+myTime+" e il tempo dell'avversario è "+vsTime),h=I,sendDataToServer(I,h,g,myTime,vsTime,m,T),setTimeout(function(){o.stopServices(),w.remove(c),w.add(v),v.playSound()},2500)}break;case"acceleration":T=i[1]}})};w.setIDOpponent=function(e){Ti.API.info("Opponent ID is "+e),I=e},w.addEventListener("open",y),b.addEventListener("click",function(){w.close()}),Ti.App.addEventListener("timeExchange",function(e){if(u){u=!1,d=require("ui/winlose/Calculating"),c=new d,r.removeEventOnOrientation();var t=r.getMotionObject();if(t.stopMotionRecognizer(),w.remove(r),w.add(c),999999999==e.flag){Ti.API.info("e.flag: "+e.flag),myTime=e.flag;try{o.sendData("times:"+e.flag)}catch(i){alert("Telepathy times in timeExchange")}}else if(888888888==e.flag){clearInterval(s),f.stop(),myTime=e.flag;try{o.sendData("times:"+e.flag)}catch(i){alert("Telepathy times timeExchange")}var n=require("ui/winlose/Lose"),a=new n(w);a.setLabelText("Ehi gringo, attento! Hai sparato troppo presto!"),setTimeout(function(){w.remove(c),w.add(a),a.playSound()},2500)}else{myTime=diffTime,Ti.API.info("myTime not parsed "+myTime),Ti.API.info("myTime parsed "+parseFloat(myTime));try{o.sendData("times:"+diffTime)}catch(i){alert("Telepathy times in timeExchange else")}}}}),w.add(v),w.add(b);var A=function(){Ti.API.info("closing window..."),o.stopServices(),i=null,o=null,myTime=0,vsTime=0,startTime=0,endTime=0,diffTime=0,r.deallocModule(),r=null,a=null};return w.addEventListener("close",A),w}function sendDataToServer(e,t,i,o,n,a,r){var l=Ti.Network.createHTTPClient({onload:function(){Ti.API.info("Received text: "+this.responseText);var e=JSON.parse(this.responseText);0==e.return?Ti.API.info("duello registrato"):-1==e.return&&Ti.API.info("duello NON registrato")},onerror:function(e){Ti.API.debug(e.error)},timeout:5e3}),s={player_one:Ti.App.Properties.getString("fb_id"),player_two:e,id_winner:t,status:0,round_time:i,acceleration1:a,acceleration2:r,diff_timestamp1:o,diff_timestamp2:n};s.num_faults1=999999999==o?1:0,s.num_faults2=999999999==n?1:0,Ti.API.info(JSON.stringify(s)),l.open("GET",global.bangServerUrl+"/challenge-quickgameChallenge.php?challenge="+JSON.stringify(s)),l.send()}module.exports=QuickGame;